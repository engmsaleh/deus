<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"

"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

<title>Visualizzazione markers da file XML</title>

<script type="text/javascript" src="flot/jquery.js"></script>
<script type="text/javascript" src="flot/jquery.flot.js"></script>

<script src="http://maps.google.com/maps?file=api&amp;v=2 &amp;key=ABQIAAAAlwN03-hocNiAHk5e51eXbxT2yXp_ZAY8_ufC3CFXhHIE1NvwkxRCsqUN1LseFVbL4a0Sh9HdggVVyg" type="text/javascript">
</script>

<script type="text/javascript">

   var poly = [] ; 	
   var line ; 
   var map;

   var newMarker;
   
   var path; 
   
   var oldLat = 0.0;
   var oldLong = 0.0;
   var zoomValue = 10;
   var bootKey = 0;
   var nodeKey = 0;	
   var numOfGeoBucket = 10;
   var sizeOfGeoBucket = 0.93205679;
   
   var markerList = new Array();
   
   var trafficElementList = new Array();
   
   var app = new Array();
   
   var mapCentered = 0;
   
   var directions = null;;
   
   var blueIcon = new GIcon(G_DEFAULT_ICON);
   blueIcon.shadow = null,
   blueIcon.printShadow = null
   blueIcon.image = "car_marker.png";
   
   var redCarIcon = new GIcon(G_DEFAULT_ICON);
   redCarIcon.shadow = null,
   redCarIcon.printShadow = null
   redCarIcon.image = "car_marker_red.png";
   
   var ssIcon = new GIcon(G_DEFAULT_ICON);
   ssIcon.shadow = null,
   ssIcon.printShadow = null
   ssIcon.image = "switch_station.png";
   
   var signIcon = new GIcon(G_DEFAULT_ICON);
   signIcon.shadow = null,
   signIcon.printShadow = null
   signIcon.image = "sign_marker.png";

 
   var greenIcon = new GIcon(G_DEFAULT_ICON);
   greenIcon.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/blank.png";
   

   var greenIconStart = new GIcon(G_DEFAULT_ICON);
   greenIconStart.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/marker1.png";

   var greenIconEnd = new GIcon(G_DEFAULT_ICON);
   greenIconEnd.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/marker2.png";
   

function initialize() {	
	
	// Set up our GMarkerOptions object
	markerOptions = { icon:greenIcon };
	markerBlueOptions = { icon:blueIcon };


	if (GBrowserIsCompatible()) {

	map = new GMap2(document.getElementById("map_canvas"));
	map.addControl(new GSmallMapControl());
	map.addControl(new GMapTypeControl());

	directions = new GDirections(map);

	//Aggiunge la scala
	map.addControl(new GScaleControl());

	//Centra la mappa in un punto particolare
	map.setCenter(new GLatLng(44.112909 , 9.835415), 13);

	var qst=location.search.substr(1);
	var dati = new Array()
	dati=qst.split("&");
	var dato1 = dati[0].substr(dati[0].indexOf("=")+1);
	nodeKey = dato1;       
	
	readSwitchStation();
	
	t=setTimeout("updateMap()",1000); 
	}
}

function updateMap() {
		
		//map.clearOverlays();	  		
		updateAllPeer();
		readTrafficElement();

		t=setTimeout("updateMap()",1000);
} 

function createMarker(position,startSS,endSS,peerId,markerOption) {
	//markerBlueOptions = { icon:blueIcon, title: peerId };
    var marker = new GMarker(position,markerOption);
  	GEvent.addListener(marker,"click", function() {
      var myHtml = "<b>Peer Id: " + peerId + "</b><br/>"+"<b>Position: " + position + "</b><br/>";
	  //route(startSS,endSS,position);	
      map.openInfoWindowHtml(position, myHtml);
    });
    return marker;
}

function route(from,to,position) {
      //console.log("Load Route Called ! from:" + from + " to:" + to);
      directions.clear();
      //directions.load("from:" + from + " to:" + to, {getPolyline:true,getSteps:true,travelMode:mode}));
	  directions.loadFromWaypoints([position,to],{getSteps:true,avoidHighways:false, travelmode: G_TRAVEL_MODE_DRIVING});
	  map.setCenter(position, 13);
}


function updateAllPeer() {

	//map.removeOverlay(overlay); 	

	GDownloadUrl("marker_ALL.xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var allMarkers = xml.documentElement.getElementsByTagName("marker");
	

	for (var i = 0; i < allMarkers.length; i++) {
		
		var punto = new GLatLng(parseFloat(allMarkers[i].getAttribute("lat")), parseFloat(allMarkers[i].getAttribute("long")));	
		var startSS = new GLatLng(parseFloat(allMarkers[i].getAttribute("startlat")), parseFloat(allMarkers[i].getAttribute("startlon")));	
		var endSS = new GLatLng(parseFloat(allMarkers[i].getAttribute("endlat")), parseFloat(allMarkers[i].getAttribute("endlon")));	
	
		var titolo = (allMarkers[i].getAttribute("descriz"));
	
		var trafficJam = allMarkers[i].getAttribute("trafficJam");
		
		if(trafficJam == "false")			
			markerBlueOptions = { icon:blueIcon, title: titolo };
		else
			markerBlueOptions = { icon:redCarIcon, title: titolo };
		
		newMarker = createMarker(punto,startSS,endSS,titolo,markerBlueOptions);
		//newMarker = new GMarker(punto, markerBlueOptions);
		
		//console.log("Checking:"+titolo+" Point:"+punto);
		
		var markerIndex = -1;
		
		for(var k=0; k<markerList.length;k++)
		{	
			if(markerList[k].id == allMarkers[i].getAttribute("descriz") )
			{
				//console.log("Stored ID:"+markerList[k].id);
				//console.log("ID:"+allMarkers[i].getAttribute("descriz"));
				//console.log("FOUNDED:"+titolo);
				
				markerIndex = k;
				
				if( ! markerList[k].point.equals(punto) )
				{
					//console.log("REMOVE OLD MARKER:"+markerList[k].id+" Point:"+markerList[k].point);
										
					map.removeOverlay(markerList[k].marker);
					
					//console.log("ADD NEW POSITION MARKER:"+titolo+" Point:"+punto);
					markerList[k].marker = newMarker;
					map.addOverlay(newMarker);
				}
			}
		}
		
		if(markerIndex==-1)
		{
			//console.log("ADD NEW MARKER:"+titolo);
			
			map.addOverlay(newMarker);
	
			var marker = {
				 point: punto,
				 id: allMarkers[i].getAttribute("descriz"),
				 marker:newMarker
			}
	
			markerList.push(marker);
			app.push(newMarker);
		}
		
	}
	
	/*
	for(var i=0; i<markerList.length;i++)
	{
		console.log("Marker:"+markerList[i].id+" Point:"+markerList[i].point);	
	}
	*/
	
	
	if(mapCentered == 0 && allMarkers != null)
	{
		//Centra la mappa in un punto particolare
		map.setCenter(new GLatLng(parseFloat(allMarkers[0].getAttribute("lat")) , parseFloat(allMarkers[0].getAttribute("long"))), 13);
		
		mapCentered = 1;
	}
	
	});

}

function readSwitchStation() {

	//map.removeOverlay(overlay); 	

	GDownloadUrl("switch_station.xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var allMarkers = xml.documentElement.getElementsByTagName("marker");
	

	for (var i = 0; i < allMarkers.length; i++) {
		
		var punto = new GLatLng(parseFloat(allMarkers[i].getAttribute("lat")), parseFloat(allMarkers[i].getAttribute("long")));	

		if(oldLat != parseFloat(allMarkers[i].getAttribute("lat")) || oldLong != parseFloat(allMarkers[i].getAttribute("long")))	
		{
			var titolo = (allMarkers[i].getAttribute("descriz"));
			markerBlueOptions = { icon:ssIcon, title: titolo };
			map.addOverlay(new GMarker(punto, markerBlueOptions));
		}
	}
	
	});

}

function readTrafficElement() {

	//map.removeOverlay(overlay); 	

	var newTrafficJamArray = new Array();

	GDownloadUrl("trafficElements.xml?"+ new Date().valueOf() , function(data, responseCode) {

		var xml = GXml.parse(data);
		var allMarkers = xml.documentElement.getElementsByTagName("marker");
		
		for (var i = 0; i < allMarkers.length; i++) {
			
			var point = new GLatLng(parseFloat(allMarkers[i].getAttribute("lat")), parseFloat(allMarkers[i].getAttribute("long")));	
			var id = allMarkers[i].getAttribute("id");
			var type = allMarkers[i].getAttribute("type");
			markerBlueOptions = { icon:signIcon, title: type };
			var trafficMarker = new GMarker(point, markerBlueOptions);
			
			newTrafficJamArray.push(trafficMarker);
				
			var teFounded = 0;
			
			for(var k=0;k<trafficElementList.length;k++)
			{
				if(trafficMarker.getLatLng().equals(trafficElementList[k].getLatLng()))
				{
					teFounded = 1;
					break;
				}	
			}
			
			if(teFounded == 0)
			{
				trafficElementList.push(trafficMarker);
				map.addOverlay(trafficMarker);	
			}
			
		}
		
	});
	
	
	var teFounded = 0;
			
	for(var k=0;k<trafficElementList.length;k++)
	{
		for(var i=0;i<newTrafficJamArray.length;i++)
			if(newTrafficJamArray[i].getLatLng().equals(trafficElementList[K].getLatLng()))
			{
				teFounded = 1;
				break;
			}
		
		if(teFounded == 0)
		{
			map.removeOverlay(trafficElementList[k]);	
		}	
	}
	
	trafficElementList = new Array();
	for(var i=0;i<newTrafficJamArray.length;i++)
		trafficElementList[i] = newTrafficJamArray[i];
	
}


</script>

</head>

<body onload="initialize()" onunload="GUnload()">
<table width="200" border="0" cellpadding="0" cellspacing="0">
  <tr>
    <th scope="row"> <div align="center" id="map_canvas" style="width: 1200px; height: 800px"></div>
    </th>
  </tr>
</table>

<table width="200" border="0" cellpadding="0" cellspacing="0">
  <tr>
    <th scope="row"> <div align="center" id="placeholder" style="width:400px;height:200px"></div>
    </th>
    <th scope="row"> <div align="center" id="placeholder2" style="width:400px;height:200px"></div>
    </th>
  </tr>
</table>
</body>
</html>
