<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"

"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

<title>Visualizzazione markers da file XML</title>

<script type="text/javascript" src="flot/jquery.js"></script>
<script type="text/javascript" src="flot/jquery.flot.js"></script>

<script src="http://maps.google.com/maps?file=api&amp;v=2 &amp;key=ABQIAAAAlwN03-hocNiAHk5e51eXbxT2yXp_ZAY8_ufC3CFXhHIE1NvwkxRCsqUN1LseFVbL4a0Sh9HdggVVyg" type="text/javascript">
</script>

<script type="text/javascript">

   var poly = [] ; 
   var line ; 
   var map;

   var newMarker;
   
   var path; 
   
   var oldLat = 0.0;
   var oldLong = 0.0;
   var zoomValue = 10;
   var bootKey = 0;
   var nodeKey = 0;	
   var numOfGeoBucket = 10;
   var sizeOfGeoBucket = 0.93205679;
   
   var markerList = new Array();
   
   var app = new Array();
   
   var mapCentered = 0;
   
   var blueIcon = new GIcon(G_DEFAULT_ICON);
   blueIcon.shadow = null,
   blueIcon.printShadow = null
   blueIcon.image = "car_marker.png";
   
   var ssIcon = new GIcon(G_DEFAULT_ICON);
   ssIcon.shadow = null,
   ssIcon.printShadow = null
   ssIcon.image = "switch_station.png";

 
   var greenIcon = new GIcon(G_DEFAULT_ICON);
   greenIcon.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/blank.png";
   

   var greenIconStart = new GIcon(G_DEFAULT_ICON);
   greenIconStart.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/marker1.png";

   var greenIconEnd = new GIcon(G_DEFAULT_ICON);
   greenIconEnd.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/marker2.png";
   

function initialize() {	
	
	// Set up our GMarkerOptions object
	markerOptions = { icon:greenIcon };
	markerBlueOptions = { icon:blueIcon };


	if (GBrowserIsCompatible()) {

	map = new GMap2(document.getElementById("map_canvas"));
	map.addControl(new GSmallMapControl());
	map.addControl(new GMapTypeControl());

	//Aggiunge la scala
	map.addControl(new GScaleControl());

	//Centra la mappa in un punto particolare
	map.setCenter(new GLatLng(44.112909 , 9.835415), 13);

	var qst=location.search.substr(1);
	var dati = new Array()
	dati=qst.split("&");
	var dato1 = dati[0].substr(dati[0].indexOf("=")+1);
	nodeKey = dato1;       
	
	readSwitchStation();
	
	t=setTimeout("updateMap()",1000); 
	}
}

function updateMap() {
		
		//map.clearOverlays();	  		
		updateAllPeer();

		t=setTimeout("updateMap()",1000);
} 

function createMarker(latlng, realLatLon, distance) {
    var marker = new GMarker(latlng);
    marker.value = distance;
    GEvent.addListener(marker,"click", function() {
      var myHtml = "<b>Distance: " + distance + "</b><br/>";
      var pol=[];
      
      if(path != null)
      	map.removeOverlay(path);

      pol.push(latlng) ;
      pol.push(realLatLon) ;
      
	  path = new GPolyline(pol) ;
	  map.addOverlay(path) ;
	  	
      map.openInfoWindowHtml(latlng, myHtml);
    });
    return marker;
}


function updateAllPeer() {

	//map.removeOverlay(overlay); 	

	GDownloadUrl("marker_ALL.xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var allMarkers = xml.documentElement.getElementsByTagName("marker");
	

	for (var i = 0; i < allMarkers.length; i++) {
		
		var punto = new GLatLng(parseFloat(allMarkers[i].getAttribute("lat")), parseFloat(allMarkers[i].getAttribute("long")));	

	
		var titolo = (allMarkers[i].getAttribute("descriz"));
		markerBlueOptions = { icon:blueIcon, title: titolo };
		newMarker = new GMarker(punto, markerBlueOptions);
		
		//console.log("Checking:"+titolo+" Point:"+punto);
		
		var markerIndex = -1;
		
		for(var k=0; k<markerList.length;k++)
		{	
			if(markerList[k].id == allMarkers[i].getAttribute("descriz") )
			{
				//console.log("Stored ID:"+markerList[k].id);
				//console.log("ID:"+allMarkers[i].getAttribute("descriz"));
				//console.log("FOUNDED:"+titolo);
				
				markerIndex = k;
				
				if( ! markerList[k].point.equals(punto) )
				{
					//console.log("REMOVE OLD MARKER:"+markerList[k].id+" Point:"+markerList[k].point);
										
					map.removeOverlay(markerList[k].marker);
					
					//console.log("ADD NEW POSITION MARKER:"+titolo+" Point:"+punto);
					
					map.addOverlay(newMarker);
				}
			}
		}
		
		if(markerIndex==-1)
		{
			//console.log("ADD NEW MARKER:"+titolo);
			
			map.addOverlay(newMarker);
	
			var marker = {
				 point: punto,
				 id: allMarkers[i].getAttribute("descriz"),
				 marker:newMarker
			}
	
			markerList.push(marker);
			app.push(newMarker);
		}
		
	}
	
	/*
	for(var i=0; i<markerList.length;i++)
	{
		console.log("Marker:"+markerList[i].id+" Point:"+markerList[i].point);	
	}
	*/
	
	
	if(mapCentered == 0)
	{
		//Centra la mappa in un punto particolare
		map.setCenter(new GLatLng(parseFloat(allMarkers[0].getAttribute("lat")) , parseFloat(allMarkers[0].getAttribute("long"))), 13);
		
		mapCentered = 1;
	}
	
	});

}

function readSwitchStation() {

	//map.removeOverlay(overlay); 	

	GDownloadUrl("switch_station.xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var allMarkers = xml.documentElement.getElementsByTagName("marker");
	

	for (var i = 0; i < allMarkers.length; i++) {
		
		var punto = new GLatLng(parseFloat(allMarkers[i].getAttribute("lat")), parseFloat(allMarkers[i].getAttribute("long")));	

		if(oldLat != parseFloat(allMarkers[i].getAttribute("lat")) || oldLong != parseFloat(allMarkers[i].getAttribute("long")))	
		{
			var titolo = (allMarkers[i].getAttribute("descriz"));
			markerBlueOptions = { icon:ssIcon, title: titolo };
			map.addOverlay(new GMarker(punto, markerBlueOptions));
		}
	}
	
	});

}


</script>

</head>

<body onload="initialize()" onunload="GUnload()">
<table width="200" border="0" cellpadding="0" cellspacing="0">
  <tr>
    <th scope="row"> <div align="center" id="map_canvas" style="width: 1200px; height: 800px"></div>
    </th>
  </tr>
</table>

<table width="200" border="0" cellpadding="0" cellspacing="0">
  <tr>
    <th scope="row"> <div align="center" id="placeholder" style="width:400px;height:200px"></div>
    </th>
    <th scope="row"> <div align="center" id="placeholder2" style="width:400px;height:200px"></div>
    </th>
  </tr>
</table>
</body>
</html>
