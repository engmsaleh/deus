<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"

"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>

<title>Visualizzazione markers da file XML</title>

<script language="javascript" type="text/javascript" src="flot/jquery.js"></script>
<script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>

<script src="http://maps.google.com/maps?file=api&v=2 &key=ABQIAAAAlwN03-hocNiAHk5e51eXbxSZaeXHpa4os1GiOOaMiniWyuCSjhRtbY3pm8X8XZAZa1jZAlLhqP_g8A" type="text/javascript">
</script>

<script type="text/javascript">

   var poly = [] ; 
   var line ; 
   var map;

   var oldLat = 0.0;
   var oldLong = 0.0;
   var zoomValue = 10;
   var bootKey = 0;
   var nodeKey = 0;	
   
   var blueIcon = new GIcon(G_DEFAULT_ICON);
   blueIcon.image = "marker26.png";

 
   var greenIcon = new GIcon(G_DEFAULT_ICON);
   greenIcon.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/blank.png";

   var greenIconStart = new GIcon(G_DEFAULT_ICON);
   greenIconStart.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/marker1.png";

   var greenIconEnd = new GIcon(G_DEFAULT_ICON);
   greenIconEnd.image = "http://gmaps-samples.googlecode.com/svn/trunk/markers/green/marker2.png";

   // Draw a circle on map around center (radius in miles)
   // Modified by Jeremy Schneider based on http://maps.huge.info/dragcircle2.htm
   function drawCircle(map, center, radius, numPoints)
   {
            poly = [] ; 
            var lat = center.lat() ;
            var lng = center.lng() ;
            var d2r = Math.PI/180 ;                // degrees to radians
            var r2d = 180/Math.PI ;                // radians to degrees
            var Clat = (radius/3963) * r2d ;      //  using 3963 as earth's radius
            var Clng = Clat/Math.cos(lat*d2r);
            
            //Add each point in the circle
            for (var i = 0 ; i < numPoints ; i++)
            {
                var theta = Math.PI * (i / (numPoints / 2)) ;
                Cx = lng + (Clng * Math.cos(theta)) ;
                Cy = lat + (Clat * Math.sin(theta)) ;
                poly.push(new GLatLng(Cy,Cx)) ;
            }

            //Remove the old line if it exists
            /*
	    if(line)
            {
                map.removeOverlay(line) ;
            }
            */

            //Add the first point to complete the circle
            poly.push(poly[0]) ;

            //Create a line with teh points from poly, red, 3 pixels wide, 80% opaque
            line = new GPolyline(poly,'#FF0000', 3, 0.8) ;
            
            map.addOverlay(line) ;
        }


function initialize() {	

	// Set up our GMarkerOptions object
	markerOptions = { icon:greenIcon };
	markerBlueOptions = { icon:blueIcon };


	if (GBrowserIsCompatible()) {

	map = new GMap2(document.getElementById("map_canvas"));
	map.addControl(new GSmallMapControl());
	map.addControl(new GMapTypeControl());

	//Aggiunge la scala
	map.addControl(new GScaleControl());

	//Centra la mappa in un punto particolare
	map.setCenter(new GLatLng(44.112909 , 9.835415), 16);

	var qst=location.search.substr(1);
	var dati = new Array()
	dati=qst.split("&");
	var dato1 = dati[0].substr(dati[0].indexOf("=")+1);
	nodeKey = dato1;       
	
	GDownloadUrl("node_markers/markers_"+dato1+".xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var markers = xml.documentElement.getElementsByTagName("marker");
	
	for (var i = 3; i < markers.length; i++) {
		var punto = new GLatLng(parseFloat(markers[i].getAttribute("lat")), parseFloat(markers[i].getAttribute("long")));
		var titolo = (markers[i].getAttribute("descriz"));	
		map.addOverlay(new GMarker(punto, {title: titolo}));
	}
	

	});

	}

	loadGraphs();

	t=setTimeout("updateMap()",1000); 
}

function updateMap() {
	
	//map.removeOverlay(overlay); 	
	
	var qst=location.search.substr(1);
	var dati = new Array()
	dati=qst.split("&");
	var dato1 = dati[0].substr(dati[0].indexOf("=")+1);
       
	nodeKey = dato1;

	zoomValue = map.getZoom();

	//GDownloadUrl("marker.xml?"+ new Date().valueOf() , function(data, responseCode) {
	GDownloadUrl("node_markers/markers_"+dato1+".xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var markers = xml.documentElement.getElementsByTagName("marker");
	
	//Centra la mappa in un punto particolare
	//map.setCenter(new GLatLng(parseFloat(markers[0].getAttribute("lat")) , parseFloat(markers[0].getAttribute("long"))), 16);

	if(oldLat != parseFloat(markers[0].getAttribute("lat")) || oldLong != parseFloat(markers[0].getAttribute("long")))
	{

		map.clearOverlays();

		updateAllPeer();

		oldLat = parseFloat(markers[0].getAttribute("lat"));
 		oldLong = parseFloat(markers[0].getAttribute("long"));

		var puntoNodo = new GLatLng(parseFloat(markers[0].getAttribute("lat")), parseFloat(markers[0].getAttribute("long")));

		map.setCenter(puntoNodo, zoomValue);

		map.addOverlay(new GMarker(puntoNodo, markerOptions));

		//Create Circle
		for(var k = 0; k < 10; k++)
			drawCircle(map, puntoNodo, k*0.93205679, 40);

		//Draw start and end point
		var startPoint = new GLatLng(parseFloat(markers[1].getAttribute("lat")), parseFloat(markers[1].getAttribute("long")));		
		var endPoint = new GLatLng(parseFloat(markers[2].getAttribute("lat")), parseFloat(markers[2].getAttribute("long")));	

		map.addOverlay(new GMarker(startPoint, { icon:greenIconStart }));
		map.addOverlay(new GMarker(endPoint, { icon:greenIconEnd }));

		for (var i = 3; i < markers.length; i++) {
			var punto = new GLatLng(parseFloat(markers[i].getAttribute("lat")), parseFloat(markers[i].getAttribute("long")));
			var titolo = (markers[i].getAttribute("descriz"));	
			map.addOverlay(new GMarker(punto, {title: titolo}));
		}

		map.addOverlay(new GMarker(puntoNodo, markerOptions));
	}
	else
		{	
			if(nodeKey == bootKey )
			{
				map.clearOverlays();	  		
				updateAllPeer();
			}
		}
	});

	if(nodeKey == bootKey )
		t=setTimeout("updateMap()",10000); 
	else
		t=setTimeout("updateMap()",1000);
} 

function updateAllPeer() {

	//map.removeOverlay(overlay); 	

	GDownloadUrl("marker_ALL.xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var allMarkers = xml.documentElement.getElementsByTagName("marker");
	

	for (var i = 0; i < allMarkers.length; i++) {
		
		if(i==0)
		  bootKey = (allMarkers[i].getAttribute("descriz"));		

		var punto = new GLatLng(parseFloat(allMarkers[i].getAttribute("lat")), parseFloat(allMarkers[i].getAttribute("long")));	

		if(oldLat != parseFloat(allMarkers[i].getAttribute("lat")) || oldLong != parseFloat(allMarkers[i].getAttribute("long")))	
		{
			var titolo = (allMarkers[i].getAttribute("descriz"));
			markerBlueOptions = { icon:blueIcon, title: titolo };
			map.addOverlay(new GMarker(punto, markerBlueOptions));
		}
	}
	});

}

function loadAllNodes() {
 
	GDownloadUrl("marker_ALL.xml?"+ new Date().valueOf() , function(data, responseCode) {

	var xml = GXml.parse(data);
	var allMarkers = xml.documentElement.getElementsByTagName("marker");
	

	for (var i = 0; i < allMarkers.length; i++) {

		var titolo = (allMarkers[i].getAttribute("descriz"));
 		option = new Option(titolo,i)
    		document.form1.fieldB.options[i] = option;
	}
	});
  
}
 
function loadSingleNode()
{
  //alert(document.form1.fieldB.options[document.form1.fieldB.value].innerHTML);
  window.location = 'marker.html?idPeer='+document.form1.fieldB.options[document.form1.fieldB.value].innerHTML;
} 

//Loads available graphs in the page
function loadGraphs()
{
	loadGraph("totalNeighbours.xml","Total Num of Neighbours","placeholder");
	loadGraph("k_buckets_graph.xml","K-Buckets Size","placeholder2");
	
	t=setTimeout("loadGraphs()",5000);
}

function loadGraph(filename,title,divName)
{

 GDownloadUrl(filename+"?"+ new Date().valueOf() , function(data, responseCode) {

		var xml = GXml.parse(data);
		var allMarkers = xml.documentElement.getElementsByTagName("marker");
		
		var minY = 0.0;
		var maxY = 0.0;

		var graph1 = [], graph2 = [];
		 
/*   
		for (var i = 0; i < 14; i += 0.5) {
			graph1.push([i, Math.sin(i)]);
			graph2.push([i, Math.cos(i)]);
		}
*/

		for (var i = 0; i < allMarkers.length; i++) {

			var x = (allMarkers[i].getAttribute("x"));
			var y = (allMarkers[i].getAttribute("y"));	
		
			var titolo = (allMarkers[i].getAttribute("descriz"));	
			
			if(i == 0)
			  minY = y;			
			else
			    if(y < minY )
			   	minY = y;

			if(y > maxY)
			   maxY = y;

			graph1.push([x, y]);
		}

		var plot = $.plot($("#"+divName),
				//[ { data: graph1, label: "graph 1"}, { data: graph2, label: "graph 2" } ], {			  
 				[ { data: graph1, label: title}], {
			       series: {
				   lines: { show: true },
				   points: { show: true }
			       },
			       grid: { hoverable: true, clickable: true }
				//,yaxis: { min: minY , max: maxY }
			     });

		function showTooltip(x, y, contents) {
			$('<div id="tooltip">' + contents + '</div>').css( {
			    position: 'absolute',
			    display: 'none',
			    top: y + 5,
			    left: x + 5,
			    border: '1px solid #fdd',
			    padding: '2px',
			    'background-color': '#fee',
			    opacity: 0.80
			}).appendTo("body").fadeIn(200);
		    }

		    var previousPoint = null;
		    $("#"+divName).bind("plothover", function (event, pos, item) {
			$("#x").text(pos.x.toFixed(2));
			$("#y").text(pos.y.toFixed(2));

		
		 	//if ($("#enableTooltip:checked").length > 0) {
			if (1 > 0) {
			    if (item) {
				if (previousPoint != item.datapoint) {
				    previousPoint = item.datapoint;
				    
				    $("#tooltip").remove();
				    var x = item.datapoint[0].toFixed(2),
				        y = item.datapoint[1].toFixed(2);
				    
				    showTooltip(item.pageX, item.pageY,
				                item.series.label + " of " + x + " = " + y);
				}
			    }
			    else {
				$("#tooltip").remove();
				previousPoint = null;            
			    }
			}
		    });

		    $("#"+divName).bind("plotclick", function (event, pos, item) {
			if (item) {
			    $("#clickdata").text("You clicked point " + item.dataIndex + " in " + item.series.label + ".");
			    plot.highlight(item.series, item.datapoint);
			}
		    });

	});
}

</script>

</head>

<body onload="initialize()" onunload="GUnload()">
<table width="200" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <th scope="row">
    <p align="center">
		<div align="center" id="map_canvas" style="width: 800px; height: 600px"></div>
			<form name="form1">
 			 <p align="center">
    			<select name="fieldB">
    			  <option size="15">  Select a Node  </option>
    			</select>
    			<input type="button" value="Load Node List" name="choice" onclick="loadAllNodes()">
   				 <input type="button" value="Load Node Map" name="load" onclick="loadSingleNode()">
   			 </p>
			</form>
	</p>
    </th>
  </tr>
</table>

<table width="200" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <th scope="row">
    <p align="center">
    	<div align="center" id="placeholder" style="width:400px;height:200px"></div>
    </p>
    </th>
    <th scope="row">
    	<p align="center">
    		<div align="center" id="placeholder2" style="width:400px;height:200px"></div>
    	</p>
    </th>
  </tr>
</table>
</body>
</html>
